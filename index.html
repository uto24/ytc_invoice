<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ইনভয়েস তৈরি ও দেখুন - Your TopUp Center</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- html2canvas library for screenshots -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* --- Global Styles & Variables --- */
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap'); /* Added Roboto for numbers/IDs */
        :root {
            --primary-color: #006eff; --secondary-color: #5a6a7e; --success-color: #20c997; --danger-color: #dc3545; --warning-color: #ffc107; --info-color: #17a2b8; --light-color: #f8f9fa; --dark-color: #212529; --white-color: #ffffff; --gray-100: #f8f9fa; --gray-200: #e9ecef; --gray-300: #dee2e6; --gray-400: #ced4da; --gray-500: #adb5bd; --gray-600: #6c757d; --gray-700: #495057; --gray-800: #343a40; --gray-900: #212529;
            --body-font: 'Hind Siliguri', sans-serif;
            --heading-font: 'Hind Siliguri', sans-serif;
            --number-font: 'Roboto', sans-serif; /* Font for numbers */
            --transition-speed: 0.3s ease;
            --border-radius: 10px; /* Slightly softer radius */
            --box-shadow-light: 0 3px 10px rgba(0, 0, 0, 0.05);
            --box-shadow-medium: 0 6px 20px rgba(0, 0, 0, 0.08);
            --box-shadow-heavy: 0 10px 30px rgba(0, 0, 0, 0.12);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; overflow-x: hidden; }
        body { font-family: var(--body-font); line-height: 1.65; color: var(--gray-700); background-color: #f4f7fc; overflow-x: hidden; }
        h1, h2, h3, h4, h5, h6 { font-family: var(--heading-font); font-weight: 600; margin-bottom: 0.9rem; color: var(--gray-900); line-height: 1.3; }
        a { text-decoration: none; color: var(--primary-color); transition: color var(--transition-speed); }
        a:hover { color: #004bbd; }
        ul { list-style: none; padding-left: 0; }
        .container { max-width: 1050px; margin: 0 auto; padding: 0 20px; } /* Slightly wider */
        section { padding: 60px 0; }

        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 28px; background-image: linear-gradient(45deg, var(--primary-color) 0%, #0056b3 100%); color: var(--white-color); border: none; border-radius: 50px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.35s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: var(--box-shadow-medium); text-transform: uppercase; letter-spacing: 0.6px; }
        .btn:hover { background-image: linear-gradient(45deg, #004bbd 0%, var(--primary-color) 100%); transform: translateY(-3px) scale(1.03); box-shadow: var(--box-shadow-heavy); }
        .btn i { font-size: 1em; margin-right: 8px; } /* Icon on left by default */
        .btn.btn-secondary { background-image: none; background-color: var(--secondary-color); box-shadow: 0 4px 10px rgba(90, 106, 126, 0.3); }
        .btn.btn-secondary:hover { background-color: #495057; transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 15px rgba(90, 106, 126, 0.4); }
        .btn.btn-print { background-image: none; background-color: var(--info-color); box-shadow: 0 4px 10px rgba(23, 162, 184, 0.3); }
        .btn.btn-print:hover { background-color: #117a8b; transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 15px rgba(23, 162, 184, 0.4); }
        .btn.btn-screenshot { background-image: none; background-color: var(--success-color); box-shadow: 0 4px 10px rgba(32, 201, 151, 0.3); }
        .btn.btn-screenshot:hover { background-color: #1aa07a; transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 15px rgba(32, 201, 151, 0.4); }


        /* --- Header Styles --- */
        #main-header { background-color: var(--white-color); box-shadow: var(--box-shadow-light); padding: 15px 0; position: sticky; top:0; z-index: 1000; }
        #main-header .container { max-width: 1100px; display: flex; justify-content: space-between; align-items: center; }
        .logo a { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); display: flex; align-items: center; }
        .logo a i { margin-right: 10px; color: var(--success-color); }

        /* --- Invoice Form Styles --- */
        #invoice-form-section { background-color: var(--white-color); padding: 35px 45px; border-radius: var(--border-radius); box-shadow: var(--box-shadow-medium); margin-bottom: 40px; transition: opacity 0.5s ease, transform 0.5s ease; }
        #invoice-form-section.hidden { opacity: 0; transform: scale(0.98); pointer-events: none; position: absolute; } /* Hide form animation */

        #invoice-form fieldset { border: 1px solid var(--gray-300); padding: 25px; margin-bottom: 30px; border-radius: var(--border-radius); background-color: var(--gray-100); }
        #invoice-form legend { font-size: 1.3rem; font-weight: 600; color: var(--primary-color); padding: 0 15px; margin-left: 15px; width: auto; border: none; background-color: var(--gray-100); /* Match fieldset bg */ display: inline-flex; align-items: center; }
        #invoice-form legend i { margin-right: 8px; font-size: 0.9em; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 25px; margin-bottom: 20px; }
        .form-group { margin-bottom: 0; } /* Remove bottom margin, use gap from form-row */
        .form-group label { display: block; margin-bottom: 7px; font-weight: 500; color: var(--gray-600); font-size: 0.9rem; }
        .form-group input[type="text"], .form-group input[type="email"], .form-group input[type="tel"], .form-group input[type="date"], .form-group input[type="number"], .form-group textarea, .form-group select { width: 100%; padding: 11px 14px; border: 1px solid var(--gray-300); border-radius: 6px; font-family: var(--body-font); font-size: 0.95rem; transition: border-color var(--transition-speed), box-shadow var(--transition-speed); background-color: var(--white-color); /* White inputs */ }
        .form-group input::placeholder, .form-group textarea::placeholder { color: var(--gray-400); }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.18rem rgba(0, 110, 255, 0.2); outline: none; }
        .form-group textarea { resize: vertical; min-height: 70px; }
        .form-group select { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url('data:image/svg+xml;utf8,<svg fill="%236c757d" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); background-repeat: no-repeat; background-position: right 10px center; padding-right: 35px; cursor: pointer;}

        /* Item Table Styles */
        .item-table { width: 100%; border-collapse: separate; /* Use separate for rounded corners */ border-spacing: 0; margin-top: 15px; border: 1px solid var(--gray-300); border-radius: var(--border-radius); overflow: hidden; /* Clip corners */ }
        .item-table th, .item-table td { padding: 10px 12px; text-align: left; font-size: 0.9rem; border-bottom: 1px solid var(--gray-200); }
        .item-table th { background-color: var(--gray-200); font-weight: 600; color: var(--gray-700); border-top: none; border-bottom-width: 2px; border-bottom-color: var(--gray-300); }
        .item-table td { border-left: 1px solid var(--gray-200); }
        .item-table td:first-child { border-left: none; }
        .item-table tr:last-child td { border-bottom: none; }
        .item-table input[type="number"] { padding: 6px 8px; font-size: 0.9rem; max-width: 75px; border-radius: 4px; }
        .item-table input[type="text"] { padding: 6px 8px; font-size: 0.9rem; border-radius: 4px;}
        .item-table .item-total { font-weight: 500; text-align: right !important; font-family: var(--number-font); }
        .item-table .action-col { width: 50px; text-align: center !important; }
        .item-table .delete-item-btn { background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 1.1rem; padding: 5px; opacity: 0.7; transition: opacity var(--transition-speed); }
        .item-table .delete-item-btn:hover { opacity: 1; }

        .add-item-btn-container { text-align: left; margin-top: 15px; }
        #add-item-btn { font-size: 0.85rem; padding: 6px 18px; background-image: none; background-color: var(--success-color); box-shadow: 0 2px 8px rgba(32, 201, 151, 0.3); }
        #add-item-btn:hover { background-color: #1aa07a; box-shadow: 0 4px 12px rgba(32, 201, 151, 0.4); }

        /* Totals Section */
        .totals-section-wrapper { display: flex; justify-content: flex-end; margin-top: 25px; }
        .totals-section { width: 100%; max-width: 450px; background-color: var(--gray-100); padding: 15px 20px; border-radius: var(--border-radius); border: 1px solid var(--gray-200); }
        .totals-section .form-group { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .totals-section label { margin-bottom: 0; width: auto; color: var(--gray-700); }
        .totals-section input { max-width: 130px; text-align: right; font-family: var(--number-font); }
        .totals-section #grandTotal { font-weight: bold; font-size: 1.1rem; color: var(--primary-color); background-color: var(--white-color); }

        .submit-button-container { text-align: center; margin-top: 40px; }

        /* --- Invoice Display Styles --- */
        #invoice-display-section { display: none; transition: opacity 0.5s ease, transform 0.5s ease; }
        #invoice-display-section.visible { display: block; opacity: 1; transform: scale(1); }
        .invoice-paper {
            background-color: var(--white-color); padding: 60px; /* More padding */
            border-radius: 5px; box-shadow: var(--box-shadow-heavy);
            margin-bottom: 30px; border: 1px solid var(--gray-300);
            position: relative; /* For stamp positioning */
            overflow: visible; /* Allow stamp to slightly overflow if desired */
        }
        .invoice-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 50px; border-bottom: 2px solid var(--primary-color); padding-bottom: 20px; }
        .invoice-header .logo-area img { max-width: 160px; margin-bottom: 15px; }
        .invoice-header .logo-area address { font-style: normal; line-height: 1.6; font-size: 0.9rem; color: var(--gray-600); }
        .invoice-header .invoice-title h2 { font-size: 2.8rem; font-weight: 700; color: var(--primary-color); margin-bottom: 8px; text-align: right; text-transform: uppercase; letter-spacing: 1.5px; }
        .invoice-header .invoice-title p { text-align: right; margin-bottom: 4px; font-size: 0.95rem; color: var(--gray-600); }
        .invoice-header .invoice-title p strong { color: var(--gray-800); font-family: var(--number-font); } /* Use number font */

        .invoice-parties { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 50px; }
        .party-details h4 { font-size: 1rem; font-weight: 700; color: var(--gray-500); margin-bottom: 12px; border-bottom: 1px solid var(--gray-300); padding-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .party-details p { margin-bottom: 4px; font-size: 0.95rem; line-height: 1.7; color: var(--gray-700); }
        .party-details p strong { font-weight: 500; color: var(--gray-900); }

        .invoice-items-table { width: 100%; border-collapse: collapse; margin-bottom: 40px; }
        .invoice-items-table thead th { background-color: var(--primary-color); color: var(--white-color); padding: 12px 15px; text-align: left; font-weight: 600; border: 1px solid var(--primary-color); font-size: 0.9rem; text-transform: uppercase; }
        .invoice-items-table tbody td { padding: 12px 15px; border: 1px solid var(--gray-300); font-size: 0.95rem; vertical-align: middle; }
        .invoice-items-table tbody tr:nth-child(even) { background-color: var(--gray-100); }
        .invoice-items-table .text-right { text-align: right; font-family: var(--number-font); }
        .invoice-items-table .text-center { text-align: center; }
        .invoice-items-table .item-description { font-weight: 500; color: var(--gray-800);}

        .invoice-summary-wrapper { display: flex; justify-content: flex-end; margin-bottom: 30px; }
        .invoice-summary { width: 50%; max-width: 350px; /* Limit summary width */ background-color: var(--gray-100); border-radius: var(--border-radius); padding: 15px 20px; border: 1px solid var(--gray-200); }
        .invoice-summary table { width: 100%; font-size: 0.95rem; }
        .invoice-summary td { padding: 9px 0; }
        .invoice-summary .summary-label { text-align: right; font-weight: 500; color: var(--gray-600); padding-right: 15px; }
        .invoice-summary .summary-value { text-align: right; font-weight: 600; color: var(--gray-800); font-family: var(--number-font); }
        .invoice-summary tr { border-bottom: 1px dotted var(--gray-300); }
        .invoice-summary tr:last-child { border-bottom: none; }
        .invoice-summary tr.grand-total .summary-label,
        .invoice-summary tr.grand-total .summary-value { font-weight: 700; font-size: 1.2rem; color: var(--primary-color); border-top: 2px solid var(--primary-color); padding-top: 10px; }

        .invoice-notes, .invoice-payment { margin-bottom: 30px; font-size: 0.9rem; line-height: 1.6; color: var(--gray-600); padding: 15px; background-color: var(--gray-100); border-radius: var(--border-radius); }
        .invoice-notes h5, .invoice-payment h5 { font-size: 1rem; font-weight: 600; color: var(--gray-800); margin-bottom: 8px; }

        /* Invoice Status Stamp */
        .status-stamp {
            position: absolute;
            top: 140px; /* Adjust as needed */
            right: 40px; /* Adjust as needed */
            font-size: 2.2rem;
            font-weight: 700;
            text-transform: uppercase;
            color: rgba(0,0,0,0.15);
            border: 7px double rgba(0,0,0,0.15);
            padding: 8px 18px;
            border-radius: 8px;
            transform: rotate(-20deg);
            z-index: 1; /* Behind items if they overlap, or adjust */
            display: none; /* Hidden by default */
            opacity: 0.6;
            letter-spacing: 1px;
            font-family: var(--heading-font);
            pointer-events: none; /* So it doesn't interfere with text selection */
        }
        .status-stamp.completed { color: var(--success-color); border-color: var(--success-color); display: block; }
        .status-stamp.rejected { color: var(--danger-color); border-color: var(--danger-color); display: block; }
        .status-stamp.not-paid { color: var(--warning-color); border-color: var(--warning-color); display: block; }


        .invoice-actions { text-align: center; padding-top: 30px; border-top: 1px solid #eee; margin-top: 30px; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;}
        .invoice-actions .btn { margin: 0 5px; }

        /* --- Print Styles --- */
        @media print {
            body * { visibility: hidden; margin: 0; padding: 0; box-shadow: none !important; }
            #invoice-display-section, #invoice-display-section * { visibility: visible; }
            .invoice-paper * { visibility: visible; } /* Ensure stamp is visible */
            .status-stamp { visibility: visible !important; opacity: 0.8 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact;}
            .status-stamp.completed { color: var(--success-color) !important; border-color: var(--success-color) !important; }
            .status-stamp.rejected { color: var(--danger-color) !important; border-color: var(--danger-color) !important; }
            .status-stamp.not-paid { color: var(--warning-color) !important; border-color: var(--warning-color) !important; }

            #main-header, #main-footer, #invoice-form-section, .invoice-actions { display: none !important; }
            .invoice-paper { box-shadow: none !important; border: none !important; padding: 0 !important; margin: 0 !important; width: 100% !important; max-width: 100% !important; position: relative; /* Keep relative for stamp */ }
            .container { max-width: 100% !important; padding: 0 !important; margin: 0 !important; }
            body { background-color: white; line-height: 1.4; font-size: 10pt; color: #000 !important; }
            h2, h3, h4, h5 { color: #000 !important; }
            a { text-decoration: none !important; color: #000 !important; }
            .invoice-header { border-bottom: 1px solid #000 !important; padding-bottom: 15px; margin-bottom: 25px;}
            .invoice-header .logo-area address, .invoice-header .invoice-title p { color: #333 !important; }
             .invoice-header .invoice-title h2 { font-size: 2rem !important; color: #000 !important; }
            .invoice-parties { grid-template-columns: 1fr 1fr; margin-bottom: 25px;}
             .party-details h4 { color: #333 !important; border-bottom: 1px solid #ccc !important; }
             .party-details p, .party-details p strong { color: #000 !important; }
            .invoice-items-table thead th { background-color: #eee !important; color: #000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; border: 1px solid #ccc !important; }
            .invoice-items-table tbody td { border: 1px solid #ccc !important; color: #000 !important; }
            .invoice-items-table tbody tr:nth-child(even) { background-color: #f9f9f9 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .invoice-summary-wrapper { justify-content: flex-end; margin-top: 20px; }
             .invoice-summary { background: none !important; border: none !important; padding: 0 !important; width: 40%; }
             .invoice-summary td { padding: 3px 0; color: #000 !important; }
             .invoice-summary .summary-label, .invoice-summary .summary-value { color: #000 !important; border: none !important; }
             .invoice-summary tr.grand-total .summary-label, .invoice-summary tr.grand-total .summary-value { border-top: 1px solid #000 !important; color: #000 !important; font-size: 1.1rem !important; }
             .invoice-notes, .invoice-payment { background: none !important; padding: 0 !important; margin-top: 20px; color: #333 !important;}
             .invoice-notes h5, .invoice-payment h5 { color: #000 !important; }
        }
        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            .invoice-header { flex-direction: column; } /* Stack logo and title */
             .invoice-parties { grid-template-columns: 1fr; /* Stack on mobile */ }
             .invoice-header .logo-area, .invoice-header .invoice-title { width: 100%; text-align: left; margin-bottom: 20px; }
             .invoice-header .invoice-title h2, .invoice-header .invoice-title p { text-align: left; }
             .party-details { width: 100%; margin-bottom: 20px; }
             .invoice-summary-wrapper { justify-content: center; }
             .invoice-summary { width: 100%; max-width: none; }
             .invoice-paper { padding: 30px; }
             #invoice-form-section { padding: 25px; }
             .status-stamp { font-size: 1.8rem; top: 100px; right: 20px; padding: 6px 12px; border-width: 5px;}

        }
        @media (max-width: 576px) {
            .form-row { grid-template-columns: 1fr; }
             #invoice-form-section { padding: 20px 15px; }
             .invoice-paper { padding: 25px 20px; }
             .invoice-header .invoice-title h2 { font-size: 2rem; }
             .invoice-summary { width: 100%; }
             .invoice-actions { flex-direction: column; gap: 10px; align-items: center; }
             .invoice-actions .btn { width: 100%; max-width: 280px; margin: 0 !important; }
             .btn { padding: 10px 25px; font-size: 0.9rem;}
             .status-stamp { font-size: 1.5rem; top: 80px; right: 15px; padding: 5px 10px; border-width: 4px; transform: rotate(-15deg);}
        }
    </style>
</head>
<body class="invoice-generator-page">

    <!-- Header (Minimal) -->
    <header id="main-header">
        <div class="container">
            <div class="logo">
                <a href="index.html"><i class="fas fa-rocket"></i> Your TopUp Center</a>
            </div>
             <a href="/apps" class="btn btn-secondary" style="padding: 8px 20px; font-size: 0.9rem;"><i class="fas fa-arrow-left"></i> ড্যাশবোর্ডে ফিরুন</a>
        </div>
    </header>

    <main>
        <section id="invoice-generator-section">
            <div class="container">

                <!-- Invoice Input Form -->
                <div id="invoice-form-section" class="fade-in visible">
                    <h2 style="text-align:center; margin-bottom: 30px;"><i class="fas fa-edit"></i> ইনভয়েস তৈরি করুন</h2>
                    <form id="invoice-form">
                        <!-- Seller Info -->
                        <fieldset>
                            <legend><i class="fas fa-store"></i> আপনার তথ্য (বিক্রেতা)</legend>
                            <div class="form-row">
                                <div class="form-group"><label for="sellerName">কোম্পানি/আপনার নাম</label><input type="text" id="sellerName" value="Your TopUp Center" required></div>
                                <div class="form-group"><label for="sellerAddress">ঠিকানা</label><textarea id="sellerAddress" rows="2">Sribordi, Sherpur - 2100, Mymensingh, Bangladesh</textarea></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group"><label for="sellerPhone">ফোন</label><input type="tel" id="sellerPhone" value="+8801781146747"></div>
                                <div class="form-group"><label for="sellerEmail">ইমেইল</label><input type="email" id="sellerEmail" value="ffdiamondstorebd@gmail.com"></div>
                                <div class="form-group"><label for="sellerWebsite">ওয়েবসাইট (ঐচ্ছিক)</label><input type="text" id="sellerWebsite" value="https://yourtopupcenter.github.io"></div>
                            </div>
                        </fieldset>

                        <!-- Buyer Info -->
                        <fieldset>
                            <legend><i class="fas fa-user-tie"></i> ক্রেতার তথ্য</legend>
                             <div class="form-row">
                                <div class="form-group"><label for="buyerName">ক্রেতার নাম</label><input type="text" id="buyerName" placeholder="গ্রাহকের নাম" required></div>
                                <div class="form-group"><label for="buyerAddress">ক্রেতার ঠিকানা</label><textarea id="buyerAddress" rows="2" placeholder="গ্রাহকের সম্পূর্ণ ঠিকানা"></textarea></div>
                             </div>
                              <div class="form-row">
                                <div class="form-group"><label for="buyerPhone">ক্রেতার ফোন (ঐচ্ছিক)</label><input type="tel" id="buyerPhone" placeholder="গ্রাহকের ফোন নম্বর"></div>
                                <div class="form-group"><label for="buyerEmail">ক্রেতার ইমেইল (ঐচ্ছিক)</label><input type="email" id="buyerEmail" placeholder="গ্রাহকের ইমেইল"></div>
                             </div>
                        </fieldset>

                        <!-- Invoice Details -->
                         <fieldset>
                            <legend><i class="fas fa-file-invoice-dollar"></i> ইনভয়েসের বিবরণ</legend>
                            <div class="form-row">
                                <div class="form-group"><label for="invoiceNumber">ইনভয়েস নম্বর</label><input type="text" id="invoiceNumber" placeholder="INV-1001" required></div>
                                <div class="form-group"><label for="invoiceDate">ইনভয়েসের তারিখ</label><input type="date" id="invoiceDate" required></div>
                                <!-- <div class="form-group"><label for="dueDate">পরিশোধের শেষ তারিখ</label><input type="date" id="dueDate" required></div> REMOVED -->
                                <div class="form-group">
                                    <label for="invoiceStatus">ইনভয়েসের অবস্থা</label>
                                    <select id="invoiceStatus">
                                        <option value="not-paid" selected>অপরিশোধিত</option>
                                        <option value="completed">পরিশোধিত</option>
                                        <option value="rejected">বাতিলকৃত</option>
                                    </select>
                                </div>
                             </div>
                        </fieldset>

                        <!-- Items -->
                        <fieldset>
                            <legend><i class="fas fa-list-ul"></i> আইটেমসমূহ</legend>
                            <table class="item-table">
                                <thead>
                                    <tr>
                                        <th>আইটেমের বিবরণ</th>
                                        <th style="width: 90px; text-align: center;">সংখ্যা</th>
                                        <th style="width: 130px; text-align: right;">একক মূল্য (৳)</th>
                                        <th style="width: 140px; text-align: right;">মোট (৳)</th>
                                        <th class="action-col"></th>
                                    </tr>
                                </thead>
                                <tbody id="invoice-items-body">
                                    <tr>
                                        <td><input type="text" class="item-desc" placeholder="সেবার নাম/ বিবরণ"></td>
                                        <td><input type="number" class="item-qty" value="1" min="0" step="any"></td>
                                        <td><input type="number" class="item-price" value="0" min="0" step="0.01"></td>
                                        <td class="item-total text-right">0.00</td>
                                        <td class="action-col"><button type="button" class="delete-item-btn"><i class="fas fa-trash-alt"></i></button></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="add-item-btn-container">
                                <button type="button" id="add-item-btn" class="btn btn-sm"><i class="fas fa-plus"></i> আইটেম যোগ করুন</button>
                            </div>
                        </fieldset>

                         <!-- Totals -->
                         <fieldset style="padding-bottom: 10px;">
                            <legend><i class="fas fa-calculator"></i> মোট হিসাব</legend>
                             <div class="totals-section-wrapper">
                                <div class="totals-section">
                                    <div class="form-group">
                                        <label for="subtotal">সাবটোটাল (৳)</label>
                                        <input type="number" id="subtotal" readonly style="background-color: var(--gray-200);">
                                    </div>
                                    <div class="form-group">
                                        <label for="discount">ডিসকাউন্ট (৳)</label>
                                        <input type="number" id="discount" value="0" min="0" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label for="tax">ট্যাক্স/ভ্যাট (%)</label>
                                        <input type="number" id="tax" value="0" min="0" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label for="grandTotal" style="font-weight: 700;">সর্বমোট (৳)</label>
                                        <input type="number" id="grandTotal" readonly style="background-color: var(--gray-200); font-weight: bold; color: var(--primary-color); font-size: 1.1rem;">
                                    </div>
                                </div>
                            </div>
                         </fieldset>

                         <!-- Notes & Payment Info -->
                          <fieldset>
                            <legend><i class="fas fa-info-circle"></i> অতিরিক্ত তথ্য</legend>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="notes">নোট/মন্তব্য (ঐচ্ছিক)</label>
                                    <textarea id="notes" rows="3" placeholder="বিশেষ কোনো নোট থাকলে এখানে লিখুন"> N/A </textarea>
                                </div>
                                <div class="form-group">
                                    <label for="paymentTerms">পেমেন্ট তথ্য/শর্তাবলী (ঐচ্ছিক)</label>
                                    <textarea id="paymentTerms" rows="3" placeholder="পেমেন্টের মাধ্যম, শর্ত ইত্যাদি লিখুন (যেমন: বিকাশ করুন 01XXXXXXXXX নম্বরে)">-</textarea>
                                </div>
                             </div>
                         </fieldset>

                        <div class="submit-button-container">
                            <button type="submit" class="btn"><i class="fas fa-eye"></i> ইনভয়েস প্রিভিউ দেখুন</button>
                        </div>
                    </form>
                </div><!-- /#invoice-form-section -->

                <!-- Invoice Display Area (Initially Hidden) -->
                <div id="invoice-display-section">
                     <div class="invoice-paper">
                         <div id="invoice-status-stamp" class="status-stamp"></div> <!-- Status Stamp Element -->
                         <!-- Invoice Header -->
                         <div class="invoice-header">
                             <div class="logo-area">
                                <h3 id="display-seller-name" style="color: var(--primary-color); font-size: 1.6rem; margin-bottom: 5px;"></h3>
                                <address id="display-seller-address" style="white-space: pre-line;"></address>
                                <p id="display-seller-phone"></p>
                                <p id="display-seller-email"></p>
                                <p id="display-seller-website"></p>
                             </div>
                             <div class="invoice-title">
                                <h2>ইনভয়েস</h2>
                                <p>ইনভয়েস #: <strong id="display-invoice-number"></strong></p>
                                <p>তারিখ: <strong id="display-invoice-date"></strong></p>
                                <!-- <p>শেষ তারিখ: <strong id="display-due-date"></strong></p> REMOVED -->
                             </div>
                         </div>

                         <!-- Invoice Parties -->
                         <div class="invoice-parties">
                             <div class="party-details">
                                <h4>প্রাপক (Bill To)</h4>
                                <p><strong id="display-buyer-name"></strong></p>
                                <p id="display-buyer-address" style="white-space: pre-line;"></p>
                                <p id="display-buyer-phone"></p>
                                <p id="display-buyer-email"></p>
                             </div>
                             <div class="party-details" style="text-align: right;">
                                 <h4>প্রেরক (Bill From)</h4>
                                 <p><strong id="display-seller-name-alt"></strong></p>
                                  <p id="display-seller-address-alt" style="white-space: pre-line;"></p>
                             </div>
                         </div>

                         <!-- Invoice Items Table -->
                         <table class="invoice-items-table">
                             <thead>
                                 <tr>
                                     <th>#</th>
                                     <th>আইটেমের বিবরণ</th>
                                     <th class="text-center">সংখ্যা</th>
                                     <th class="text-right">মূল্য (৳)</th>
                                     <th class="text-right">মোট (৳)</th>
                                 </tr>
                             </thead>
                             <tbody id="display-items-body">
                             </tbody>
                         </table>
                         <template id="invoice-item-template">
                             <tr>
                                <td class="item-sl"></td>
                                <td class="item-description"></td>
                                <td class="text-center item-qty"></td>
                                <td class="text-right item-unit-price"></td>
                                <td class="text-right item-line-total"></td>
                             </tr>
                         </template>

                         <!-- Invoice Summary -->
                          <div class="invoice-summary-wrapper">
                              <div class="invoice-summary">
                                  <table>
                                      <tbody>
                                          <tr>
                                              <td class="summary-label">সাবটোটাল:</td>
                                              <td class="summary-value" id="display-subtotal">৳ ০.০০</td>
                                          </tr>
                                           <tr>
                                              <td class="summary-label">ডিসকাউন্ট:</td>
                                              <td class="summary-value" id="display-discount">৳ ০.০০</td>
                                          </tr>
                                           <tr>
                                              <td class="summary-label">ট্যাক্স/ভ্যাট (<span id="display-tax-rate">০</span>%):</td>
                                              <td class="summary-value" id="display-tax-amount">৳ ০.০০</td>
                                          </tr>
                                           <tr class="grand-total">
                                              <td class="summary-label">সর্বমোট:</td>
                                              <td class="summary-value" id="display-grand-total">৳ ০.০০</td>
                                          </tr>
                                      </tbody>
                                  </table>
                              </div>
                          </div>

                         <!-- Notes & Payment Terms -->
                         <div class="invoice-notes">
                             <h5>নোট:</h5>
                             <p id="display-notes">[এখানে নোটস আসবে]</p>
                         </div>
                          <div class="invoice-payment">
                             <h5>পেমেন্ট তথ্য/শর্তাবলী:</h5>
                             <p id="display-payment-terms" style="white-space: pre-line;">[এখানে পেমেন্ট তথ্য আসবে]</p>
                         </div>
                         <div style="margin-top: 40px; text-align: center; font-size: 0.85rem; color: var(--gray-500);">
                            ইনভয়েসটি Your TopUp Center দ্বারা তৈরি করা হয়েছে।
                         </div>

                     </div> <!-- /.invoice-paper -->

                     <div class="invoice-actions">
                         <button type="button" onclick="window.print();" class="btn btn-print">
                             <i class="fas fa-print"></i> প্রিন্ট / PDF
                         </button>
                         <button type="button" id="screenshot-invoice-btn" class="btn btn-screenshot">
                            <i class="fas fa-camera"></i> স্ক্রিনশট নিন
                         </button>
                          <button type="button" id="edit-invoice-btn" class="btn btn-secondary">
                             <i class="fas fa-edit"></i> আবার এডিট করুন
                         </button>
                     </div>

                </div> <!-- /#invoice-display-section -->

            </div> <!-- /.container -->
        </section>
    </main>

    <!-- Footer -->
    <footer id="main-footer" style="padding: 30px 0 10px; background-color: var(--dark-color); color: var(--gray-300); font-size: 0.9rem;">
         <div class="container" style="text-align:center;">
            কপিরাইট © <span id="current-year"></span> Your TopUp Center. সর্বস্বত্ব সংরক্ষিত। <br> ডেভেলপড উইথ <i class="fas fa-heart" style="color: #e74c3c;"></i> বাই <a href="https://utechsolution.com/" target="_blank" rel="noopener noreferrer" style="color: var(--info-color);">U Tech Web Solution</a>
         </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Invoice Generator DOM Loaded");

            const invoiceForm = document.getElementById('invoice-form');
            const invoiceFormSection = document.getElementById('invoice-form-section');
            const invoiceDisplaySection = document.getElementById('invoice-display-section');
            const editButton = document.getElementById('edit-invoice-btn');
            const itemsTableBody = document.getElementById('invoice-items-body');
            const addItemBtn = document.getElementById('add-item-btn');
            const screenshotBtn = document.getElementById('screenshot-invoice-btn');

            const sellerNameInput = document.getElementById('sellerName');
            const sellerAddressInput = document.getElementById('sellerAddress');
            const sellerPhoneInput = document.getElementById('sellerPhone');
            const sellerEmailInput = document.getElementById('sellerEmail');
            const sellerWebsiteInput = document.getElementById('sellerWebsite');
            const buyerNameInput = document.getElementById('buyerName');
            const buyerAddressInput = document.getElementById('buyerAddress');
            const buyerPhoneInput = document.getElementById('buyerPhone');
            const buyerEmailInput = document.getElementById('buyerEmail');
            const invoiceNumberInput = document.getElementById('invoiceNumber');
            const invoiceDateInput = document.getElementById('invoiceDate');
            // const dueDateInput = document.getElementById('dueDate'); // REMOVED
            const invoiceStatusInput = document.getElementById('invoiceStatus'); // ADDED
            const subtotalInput = document.getElementById('subtotal');
            const discountInput = document.getElementById('discount');
            const taxInput = document.getElementById('tax');
            const grandTotalInput = document.getElementById('grandTotal');
            const notesInput = document.getElementById('notes');
            const paymentTermsInput = document.getElementById('paymentTerms');

            const displaySellerName = document.getElementById('display-seller-name');
            const displaySellerNameAlt = document.getElementById('display-seller-name-alt');
            const displaySellerAddress = document.getElementById('display-seller-address');
            const displaySellerAddressAlt = document.getElementById('display-seller-address-alt');
            const displaySellerPhone = document.getElementById('display-seller-phone');
            const displaySellerEmail = document.getElementById('display-seller-email');
            const displaySellerWebsite = document.getElementById('display-seller-website');
            const displayBuyerName = document.getElementById('display-buyer-name');
            const displayBuyerAddress = document.getElementById('display-buyer-address');
            const displayBuyerPhone = document.getElementById('display-buyer-phone');
            const displayBuyerEmail = document.getElementById('display-buyer-email');
            const displayInvoiceNumber = document.getElementById('display-invoice-number');
            const displayInvoiceDate = document.getElementById('display-invoice-date');
            // const displayDueDate = document.getElementById('display-due-date'); // REMOVED
            const displayInvoiceStamp = document.getElementById('invoice-status-stamp'); // ADDED
            const displayItemsBody = document.getElementById('display-items-body');
            const displaySubtotal = document.getElementById('display-subtotal');
            const displayDiscount = document.getElementById('display-discount');
            const displayTaxRate = document.getElementById('display-tax-rate');
            const displayTaxAmount = document.getElementById('display-tax-amount');
            const displayGrandTotal = document.getElementById('display-grand-total');
            const displayNotes = document.getElementById('display-notes');
            const displayPaymentTerms = document.getElementById('display-payment-terms');
            const itemTemplate = document.getElementById('invoice-item-template');
            const currentYearSpan = document.getElementById('current-year');
             if (currentYearSpan) {
                currentYearSpan.textContent = new Date().getFullYear();
            }


            const formatCurrency = (amount) => `৳ ${amount.toFixed(2)}`;
            const formatDate = (dateString) => {
                if (!dateString) return '[তারিখ নেই]';
                try {
                    return new Date(dateString).toLocaleDateString('bn-BD', { year: 'numeric', month: 'long', day: 'numeric' });
                } catch (e) {
                    return dateString;
                }
            };

             const calculateTotals = () => {
                let currentSubtotal = 0;
                const itemRows = itemsTableBody.querySelectorAll('tr');

                itemRows.forEach(row => {
                    const qtyInput = row.querySelector('.item-qty');
                    const priceInput = row.querySelector('.item-price');
                    const totalCell = row.querySelector('.item-total');

                    const qty = parseFloat(qtyInput.value) || 0;
                    const price = parseFloat(priceInput.value) || 0;
                    const lineTotal = qty * price;

                    totalCell.textContent = lineTotal.toFixed(2);
                    currentSubtotal += lineTotal;
                });

                subtotalInput.value = currentSubtotal.toFixed(2);

                const discount = parseFloat(discountInput.value) || 0;
                const taxRate = parseFloat(taxInput.value) || 0;
                const taxableAmount = currentSubtotal - discount;
                const taxAmount = taxableAmount > 0 ? taxableAmount * (taxRate / 100) : 0;
                const currentGrandTotal = taxableAmount + taxAmount;

                grandTotalInput.value = currentGrandTotal.toFixed(2);
            };

             itemsTableBody.addEventListener('input', calculateTotals);
             discountInput.addEventListener('input', calculateTotals);
             taxInput.addEventListener('input', calculateTotals);

             itemsTableBody.addEventListener('click', (e) => {
                 if (e.target.closest('.delete-item-btn')) {
                     const row = e.target.closest('tr');
                      if (itemsTableBody.querySelectorAll('tr').length > 1) {
                           row.remove();
                           calculateTotals();
                      } else {
                          alert("অন্তত একটি আইটেম রাখতে হবে।");
                      }
                 }
             });

            if (addItemBtn) {
                 addItemBtn.addEventListener('click', () => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="text" class="item-desc" placeholder="সেবার নাম/ বিবরণ"></td>
                        <td><input type="number" class="item-qty" value="1" min="0" step="any"></td>
                        <td><input type="number" class="item-price" value="0" min="0" step="0.01"></td>
                        <td class="item-total text-right">0.00</td>
                        <td class="action-col"><button type="button" class="delete-item-btn"><i class="fas fa-trash-alt"></i></button></td>
                    `;
                    itemsTableBody.appendChild(newRow);
                 });
             }


            invoiceForm.addEventListener('submit', function(event) {
                event.preventDefault();
                console.log("Generating Invoice Preview");

                displaySellerName.textContent = sellerNameInput.value || '[বিক্রেতার নাম]';
                displaySellerNameAlt.textContent = sellerNameInput.value || '[বিক্রেতার নাম]';
                displaySellerAddress.innerHTML = (sellerAddressInput.value || '[ঠিকানা]').replace(/\n/g, '<br>');
                displaySellerAddressAlt.innerHTML = (sellerAddressInput.value || '[ঠিকানা]').replace(/\n/g, '<br>');
                displaySellerPhone.textContent = sellerPhoneInput.value ? `ফোন: ${sellerPhoneInput.value}` : '';
                displaySellerEmail.textContent = sellerEmailInput.value ? `ইমেইল: ${sellerEmailInput.value}` : '';
                displaySellerWebsite.textContent = sellerWebsiteInput.value ? `ওয়েবসাইট: ${sellerWebsiteInput.value}` : '';

                displayBuyerName.textContent = buyerNameInput.value || '[ক্রেতার নাম]';
                displayBuyerAddress.innerHTML = (buyerAddressInput.value || '[ক্রেতার ঠিকানা]').replace(/\n/g, '<br>');
                displayBuyerPhone.textContent = buyerPhoneInput.value ? `ফোন: ${buyerPhoneInput.value}` : '';
                displayBuyerEmail.textContent = buyerEmailInput.value ? `ইমেইল: ${buyerEmailInput.value}` : '';

                displayInvoiceNumber.textContent = invoiceNumberInput.value || '[নম্বর]';
                displayInvoiceDate.textContent = formatDate(invoiceDateInput.value);
                // displayDueDate.textContent = formatDate(dueDateInput.value); // REMOVED

                // Status Stamp
                const statusValue = invoiceStatusInput.value;
                let statusText = '';
                displayInvoiceStamp.className = 'status-stamp'; // Reset classes

                if (statusValue === 'completed') {
                    statusText = 'পরিশোধিত';
                    displayInvoiceStamp.classList.add('completed');
                } else if (statusValue === 'rejected') {
                    statusText = 'বাতিলকৃত';
                    displayInvoiceStamp.classList.add('rejected');
                } else if (statusValue === 'not-paid') {
                    statusText = 'অপরিশোধিত';
                    displayInvoiceStamp.classList.add('not-paid');
                }
                displayInvoiceStamp.textContent = statusText;
                displayInvoiceStamp.style.display = 'block';


                displayItemsBody.innerHTML = '';
                let itemCounter = 1;
                 const itemRows = itemsTableBody.querySelectorAll('tr');
                 itemRows.forEach(row => {
                     const descInput = row.querySelector('.item-desc');
                     const qtyInput = row.querySelector('.item-qty');
                     const priceInput = row.querySelector('.item-price');
                     const totalCell = row.querySelector('.item-total');
                     const desc = descInput.value.trim();
                     if (desc) {
                         const newRow = itemTemplate.content.cloneNode(true).querySelector('tr');
                         newRow.querySelector('.item-sl').textContent = itemCounter++;
                         newRow.querySelector('.item-description').textContent = desc;
                         newRow.querySelector('.item-qty').textContent = parseFloat(qtyInput.value) || 0;
                         newRow.querySelector('.item-unit-price').textContent = formatCurrency(parseFloat(priceInput.value) || 0);
                         newRow.querySelector('.item-line-total').textContent = formatCurrency(parseFloat(totalCell.textContent) || 0);
                         displayItemsBody.appendChild(newRow);
                     }
                 });

                 const finalSubtotal = parseFloat(subtotalInput.value) || 0;
                 const finalDiscount = parseFloat(discountInput.value) || 0;
                 const finalTaxRate = parseFloat(taxInput.value) || 0;
                 const taxableAmount = finalSubtotal - finalDiscount;
                 const finalTaxAmount = taxableAmount > 0 ? taxableAmount * (finalTaxRate / 100) : 0;
                 const finalGrandTotal = parseFloat(grandTotalInput.value) || 0;

                 displaySubtotal.textContent = formatCurrency(finalSubtotal);
                 displayDiscount.textContent = formatCurrency(finalDiscount);
                 displayTaxRate.textContent = finalTaxRate;
                 displayTaxAmount.textContent = formatCurrency(finalTaxAmount);
                 displayGrandTotal.textContent = formatCurrency(finalGrandTotal);

                 displayNotes.textContent = notesInput.value || 'কোনো নোট নেই।';
                 displayPaymentTerms.innerHTML = (paymentTermsInput.value || 'কোনো পেমেন্ট তথ্য নেই।').replace(/\n/g, '<br>');

                invoiceFormSection.classList.add('hidden');
                setTimeout(() => {
                     invoiceFormSection.style.display = 'none';
                     invoiceDisplaySection.style.display = 'block';
                     invoiceDisplaySection.classList.add('visible');
                     window.scrollTo(0, 0);
                 }, 500);
            });

             editButton.addEventListener('click', function() {
                 invoiceDisplaySection.classList.remove('visible');
                 if (displayInvoiceStamp) { // Hide stamp when editing
                    displayInvoiceStamp.style.display = 'none';
                 }
                 setTimeout(() => {
                      invoiceDisplaySection.style.display = 'none';
                      invoiceFormSection.style.display = 'block';
                      invoiceFormSection.classList.remove('hidden');
                      window.scrollTo(0, 0);
                 }, 500);
             });

            if (screenshotBtn) {
                screenshotBtn.addEventListener('click', function() {
                    const invoicePaperElement = document.querySelector('.invoice-paper');
                    const invoiceNumber = document.getElementById('display-invoice-number').textContent || 'invoice';
                    const stampElement = document.getElementById('invoice-status-stamp');

                    if (invoicePaperElement && typeof html2canvas === 'function') {
                        // Temporarily ensure stamp is visible for screenshot if it's part of the design
                        const stampOriginalDisplay = stampElement ? stampElement.style.display : '';
                        if (stampElement && stampOriginalDisplay === 'none') {
                            // This logic might need adjustment based on when stamp becomes visible
                            // For now, assuming it's already visible if we are in preview mode
                        }

                        // Options for html2canvas
                        const options = {
                            scale: 2, // For HD quality (2x resolution)
                            logging: false, // Set to true for debugging
                            useCORS: true,
                            allowTaint: true, // May be needed if external resources are used
                            backgroundColor: '#ffffff', // Ensure background is white if not transparent
                            onclone: (document) => {
                                // If there are elements that rely on :hover or :active,
                                // you might need to apply those styles directly here for the clone.
                                // For instance, ensure the stamp is styled correctly in the clone.
                                let clonedStamp = document.getElementById('invoice-status-stamp');
                                if(clonedStamp && stampElement){
                                    clonedStamp.className = stampElement.className; // ensure classes are copied
                                    clonedStamp.style.display = 'block'; // ensure it is visible
                                }
                            }
                        };


                        // Temporarily remove box-shadow for a cleaner edge on the screenshot
                        const originalBoxShadow = invoicePaperElement.style.boxShadow;
                        const originalBorder = invoicePaperElement.style.border;
                        invoicePaperElement.style.boxShadow = 'none';
                        // invoicePaperElement.style.border = '1px solid #ccc'; // Optional: add a thin border for definition if needed

                        html2canvas(invoicePaperElement, options).then(canvas => {
                            // Restore original styles
                            invoicePaperElement.style.boxShadow = originalBoxShadow;
                            invoicePaperElement.style.border = originalBorder;
                            if (stampElement && stampOriginalDisplay === 'none' && stampElement.style.display === 'block') {
                                // Restore stamp display if it was changed
                                // stampElement.style.display = stampOriginalDisplay;
                            }

                            const image = canvas.toDataURL('image/png', 1.0); // PNG format, 1.0 quality (lossless)
                            const link = document.createElement('a');
                            link.href = image;
                            link.download = `Invoice-${invoiceNumber.replace(/[^a-z0-9]/gi, '_')}.png`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        }).catch(err => {
                            console.error("Screenshot error:", err);
                            alert("স্ক্রিনশট নিতে একটি সমস্যা হয়েছে। অনুগ্রহ করে কনসোল চেক করুন।");
                            // Restore original styles even on error
                            invoicePaperElement.style.boxShadow = originalBoxShadow;
                            invoicePaperElement.style.border = originalBorder;
                        });
                    } else if (typeof html2canvas !== 'function') {
                        alert("স্ক্রিনশট লাইব্রেরি (html2canvas) লোড হয়নি।");
                    } else {
                        alert("ইনভয়েস পেপার খুঁজে পাওয়া যায়নি।");
                    }
                });
            }


             const today = new Date().toISOString().split('T')[0];
             invoiceDateInput.value = today;
             // const nextWeek = new Date(); // REMOVED
             // nextWeek.setDate(nextWeek.getDate() + 7); // REMOVED
             // dueDateInput.value = nextWeek.toISOString().split('T')[0]; // REMOVED
             invoiceNumberInput.value = `INV-${Date.now().toString().slice(-6)}`;
             calculateTotals();
        });
    </script>

</body>
</html>
